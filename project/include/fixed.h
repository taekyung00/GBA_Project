#ifndef FIXED_H
#define FIXED_H

#include "gba.h" // u32, bool 등 기본 타입 사용을 위해 포함

// =========================================================================
// 💡 고정 소수점(Fixed Point) 라이브러리 (Q24.8 Format)
// -------------------------------------------------------------------------
//
// [1. 왜 사용하는가?]
//    GBA(ARM7TDMI)에는 실수(float)를 계산하는 하드웨어(FPU)가 없습니다.
//    float를 쓰면 소프트웨어적으로 에뮬레이션하느라 속도가 수십 배 느려집니다.
//    따라서 "256을 곱한 정수"를 사용하여 소수점 연산을 흉내 냅니다.
//
// [2. 하드웨어의 관점 (Hardware Agnostic)]
//    GBA 하드웨어(CPU, PPU)는 이 값이 고정 소수점인지 모릅니다.
//    그냥 '256배 큰 정수'로 취급하여 덧셈/뺄셈을 수행합니다.
//    우리가 화면(VRAM/OAM)에 값을 넘길 때만 '정수'로 통역해주면 됩니다.
//
// [3. 사용 원칙 (The Two Worlds)]
//    - 물리 세계 (Physics): 위치(x,y), 속도, 중력 등 움직이는 값 -> 무조건 'fixed' 유지
//    - 논리 세계 (Logic): 아이템 개수, 인덱스, 타일 번호 -> 일반 'int' 사용
//    - 렌더링 (Render): 그리기 직전에 'fixed' -> 'int'로 변환하여 하드웨어에 전달
//
// =========================================================================


// -------------------------------------------------------------------------
// 1. 설정 상수 (Configuration)
// -------------------------------------------------------------------------
#define FIX_SHIFT    8                // 하위 8비트를 소수부로 사용
#define FIX_SCALE    (1 << FIX_SHIFT) // 256 (1.0을 의미하는 정수 값)
#define FIX_MASK     (FIX_SCALE - 1)  // 0xFF (소수부 비트 마스크)
#define FIX_ONE      FIX_SCALE        // 1.0


// -------------------------------------------------------------------------
// 2. 자료형 정의 (Typedef)
// -------------------------------------------------------------------------
// int와 같지만, "이 변수는 256배 튀겨진 값이다"라고 명시하기 위해 사용합니다.
typedef int fixed;


// -------------------------------------------------------------------------
// 3. 변환 매크로 (Conversion Macros)
// -------------------------------------------------------------------------

// [정수 -> 고정 소수점] (Enter Physics World)
// 사용: 초기값 설정, 정수 더하기
// 예: INT_TO_FIX(10) -> 2560
#define INT_TO_FIX(n)    ((fixed)((n) << FIX_SHIFT))

// [실수 -> 고정 소수점] (Data Import)
// 사용: 물리 상수 초기화 (예: 중력 9.8, 마찰력 0.1)
// 주의: float 연산이 포함되므로 '초기화 단계'에서만 사용할 것. 루프 내부 금지.
#define FLOAT_TO_FIX(f)  ((fixed)((f) * (float)FIX_SCALE))

// [고정 소수점 -> 정수 (버림)] (Render to Hardware)
// 사용: 최종적으로 화면(VRAM)에 좌표를 찍을 때
// 예: 2560(10.0) -> 10, 2688(10.5) -> 10
#define FIX_TO_INT(n)    ((n) >> FIX_SHIFT)

// [고정 소수점 -> 정수 (반올림)] (Render Precise)
// 사용: 더 정확한 좌표가 필요할 때
// 예: 10.5 -> 11, 10.4 -> 10
#define FIX_ROUND(n)     (((n) + (FIX_SCALE / 2)) >> FIX_SHIFT)

// [고정 소수점 -> 실수] (Debugging)
// 사용: printf 등으로 값을 확인하고 싶을 때
// 주의: 절대 게임 로직이나 연산용으로 사용하지 말 것 (매우 느림).
#define FIX_TO_FLOAT(n)  ((float)(n) / (float)FIX_SCALE)


// -------------------------------------------------------------------------
// 4. 산술 연산 함수 (Arithmetic Functions)
// -------------------------------------------------------------------------

// [덧셈/뺄셈]
// 그냥 + - 연산자를 사용하면 됩니다. (비트 이동 필요 없음)
// fixed c = a + b;


// [곱셈]
// 원리: (A * 256) * (B * 256) = (A * B) * 65536
// 결과가 256^2배가 되므로, 다시 256(SHIFT)으로 나눠줘야 원래 스케일로 돌아옴.
// (long long) 캐스팅: 32비트끼리 곱하면 오버플로우가 발생할 수 있어 64비트로 확장.
static inline fixed fix_mul(fixed a, fixed b) {
    return (fixed)(((long long)a * b) >> FIX_SHIFT);
}

// [나눗셈]
// 원리: (A * 256) / (B * 256) = A / B (스케일 소실됨)
// 미리 A에 256을 한번 더 곱해놓고 나눠야 스케일(256배)이 유지됨.
static inline fixed fix_div(fixed a, fixed b) {
    return (fixed)(((long long)a << FIX_SHIFT) / b);
}

// [절댓값]
static inline fixed fix_abs(fixed a) {
    return (a < 0) ? -a : a;
}

// [최소값]
static inline fixed fix_min(fixed a, fixed b) {
    return (a < b) ? a : b;
}

// [최대값]
static inline fixed fix_max(fixed a, fixed b) {
    return (a > b) ? a : b;
}

#endif // FIXED_H